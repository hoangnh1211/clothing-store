{"ast":null,"code":"\"use strict\";\n\nconst WritableTrackingBuffer = require('./tracking-buffer/writable-tracking-buffer');\n\nconst writeAllHeaders = require('./all-headers').writeToTrackingBuffer;\n/*\n  s2.2.6.8\n */\n\n\nconst OPERATION_TYPE = module.exports.OPERATION_TYPE = {\n  TM_GET_DTC_ADDRESS: 0x00,\n  TM_PROPAGATE_XACT: 0x01,\n  TM_BEGIN_XACT: 0x05,\n  TM_PROMOTE_XACT: 0x06,\n  TM_COMMIT_XACT: 0x07,\n  TM_ROLLBACK_XACT: 0x08,\n  TM_SAVE_XACT: 0x09\n};\nconst ISOLATION_LEVEL = module.exports.ISOLATION_LEVEL = {\n  NO_CHANGE: 0x00,\n  READ_UNCOMMITTED: 0x01,\n  READ_COMMITTED: 0x02,\n  REPEATABLE_READ: 0x03,\n  SERIALIZABLE: 0x04,\n  SNAPSHOT: 0x05\n};\nconst isolationLevelByValue = {};\n\nfor (const name in ISOLATION_LEVEL) {\n  const value = ISOLATION_LEVEL[name];\n  isolationLevelByValue[value] = name;\n}\n\nclass Transaction {\n  constructor(name, isolationLevel) {\n    this.name = name;\n    this.isolationLevel = isolationLevel;\n    this.outstandingRequestCount = 1;\n  }\n\n  beginPayload(txnDescriptor) {\n    const buffer = new WritableTrackingBuffer(100, 'ucs2');\n    writeAllHeaders(buffer, txnDescriptor, this.outstandingRequestCount);\n    buffer.writeUShort(OPERATION_TYPE.TM_BEGIN_XACT);\n    buffer.writeUInt8(this.isolationLevel);\n    buffer.writeUInt8(this.name.length * 2);\n    buffer.writeString(this.name, 'ucs2');\n    return {\n      data: buffer.data,\n      toString: () => {\n        return 'Begin Transaction: name=' + this.name + ', isolationLevel=' + isolationLevelByValue[this.isolationLevel];\n      }\n    };\n  }\n\n  commitPayload(txnDescriptor) {\n    const buffer = new WritableTrackingBuffer(100, 'ascii');\n    writeAllHeaders(buffer, txnDescriptor, this.outstandingRequestCount);\n    buffer.writeUShort(OPERATION_TYPE.TM_COMMIT_XACT);\n    buffer.writeUInt8(this.name.length * 2);\n    buffer.writeString(this.name, 'ucs2'); // No fBeginXact flag, so no new transaction is started.\n\n    buffer.writeUInt8(0);\n    return {\n      data: buffer.data,\n      toString: () => {\n        return 'Commit Transaction: name=' + this.name;\n      }\n    };\n  }\n\n  rollbackPayload(txnDescriptor) {\n    const buffer = new WritableTrackingBuffer(100, 'ascii');\n    writeAllHeaders(buffer, txnDescriptor, this.outstandingRequestCount);\n    buffer.writeUShort(OPERATION_TYPE.TM_ROLLBACK_XACT);\n    buffer.writeUInt8(this.name.length * 2);\n    buffer.writeString(this.name, 'ucs2'); // No fBeginXact flag, so no new transaction is started.\n\n    buffer.writeUInt8(0);\n    return {\n      data: buffer.data,\n      toString: () => {\n        return 'Rollback Transaction: name=' + this.name;\n      }\n    };\n  }\n\n  savePayload(txnDescriptor) {\n    const buffer = new WritableTrackingBuffer(100, 'ascii');\n    writeAllHeaders(buffer, txnDescriptor, this.outstandingRequestCount);\n    buffer.writeUShort(OPERATION_TYPE.TM_SAVE_XACT);\n    buffer.writeUInt8(this.name.length * 2);\n    buffer.writeString(this.name, 'ucs2');\n    return {\n      data: buffer.data,\n      toString: () => {\n        return 'Save Transaction: name=' + this.name;\n      }\n    };\n  }\n\n  isolationLevelToTSQL() {\n    switch (this.isolationLevel) {\n      case ISOLATION_LEVEL.READ_UNCOMMITTED:\n        return 'READ UNCOMMITTED';\n\n      case ISOLATION_LEVEL.READ_COMMITTED:\n        return 'READ COMMITTED';\n\n      case ISOLATION_LEVEL.REPEATABLE_READ:\n        return 'REPEATABLE READ';\n\n      case ISOLATION_LEVEL.SERIALIZABLE:\n        return 'SERIALIZABLE';\n\n      case ISOLATION_LEVEL.SNAPSHOT:\n        return 'SNAPSHOT';\n    }\n\n    return '';\n  }\n\n}\n\nmodule.exports.Transaction = Transaction;","map":null,"metadata":{},"sourceType":"script"}